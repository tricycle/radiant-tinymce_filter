(function(){tinymce.create("tinymce.plugins.RadiantLinkingPlugin",{getInfo:function(){return{longname:"Radiant Linking Integration",author:"Gerrit Kaiser, Tricycle Developments",authorurl:"http://tricycledevelopments.com",infourl:"http://github.com/tricycle/radiant-tinymce_filter/tree/",version:"0.1"}},init:function(A,B){this.editor=A;A.addCommand("mceRadiantLinkDialog",function(){var C=A.selection;if(C.isCollapsed()&&!A.dom.getParent(C.getNode(),"A")){return }RadiantLinkingPopup.show()});A.addButton("link",{title:"advlink.link_desc",cmd:"mceRadiantLinkDialog"});A.addShortcut("ctrl+k","advlink.advlink_desc","mceRadiantLinkDialog");A.onNodeChange.add(function(D,C,F,E){C.setDisabled("link",E&&F.nodeName!="A");C.setActive("link",F.nodeName=="A"&&!F.name)})}});tinymce.PluginManager.add("radiant_linking",tinymce.plugins.RadiantLinkingPlugin)})();var RadiantLinkingPopup={init:function(A){this.id=A;this.editor=tinymce.EditorManager.activeEditor;this.hrefInput=$(this.id).select("form")[0].getInputs("text","href")[0];this.attachBehaviour()},attachBehaviour:function(){$$("#"+this.id+" .tabs a").each(function(A){A.observe("click",function(E){E.stop();var D=function(F){F.removeClassName("here")};var B=this.attributes.href.value;var C=this.up(".tabs");this.addClassName("here");this.siblings().each(D);C.adjacent(".pane").each(D);C.adjacent(B).each(function(F){F.addClassName("here")})})});$$("#"+this.id+" #internal-link-pane a").each(function(A){A.observe("click",function(B){B.stop();RadiantLinkingPopup.insertLink(this.title)})});$$("#"+this.id+" #external-link-pane form").each(function(A){A.observe("submit",function(B){B.stop();RadiantLinkingPopup.insertLink(RadiantLinkingPopup.hrefInput.value)})})},show:function(){var A=$(this.id);center(A);this.editor=tinymce.EditorManager.activeEditor;this.populateField();A.show()},close:function(){$(this.id).hide()},undoable:function(A){this.editor.execCommand("mceBeginUndoLevel");A();this.editor.execCommand("mceEndUndoLevel")},getSelectedLink:function(){return this.editor.dom.getParent(this.editor.selection.getNode(),"A")},isLinkSelected:function(){return this.getSelectedLink()!=null},populateField:function(){if(this.isLinkSelected()){this.hrefInput.value=this.getSelectedLink().href}},insertLink:function(A){var B=function(){A!=""&&A!="http://"};if(B){this.editor.execCommand("CreateLink",false,A)}this.close()}};var MiniSiteMap=Class.create(SiteMap,{getBranch:function(B){var D=this.extractPageId(B),C=this.extractLevel(B),A=$("busy-"+D);new Ajax.Updater(B,"/admin/pagetree/children/"+D+"/"+C,{insertion:"after",onLoading:function(){A.show();this.updating=true}.bind(this),onComplete:function(){A.fade();this.updating=false;RadiantLinkingPopup.attachBehaviour()}.bind(this),method:"get"})}});document.observe("dom:loaded",function(){when("table.index",function(A){if(A.identify()=="wysiwyg-site-map"){new MiniSiteMap(A)}});RadiantLinkingPopup.init("tinymce-linking-popup")});